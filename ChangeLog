Changelog
--------------------------------------------------------------------------------

Changes apply to trailing revision version: FooVersion has Foo change:

Foo change
FooVersion
--------------------------------------------------------------------------------
Changes for cyg-apt script

Incorrect file
Revision 1
----------

Revision 2
----------

* Added original 2006 version cyg-apt by Jan Nieuwenhuizen from http://lilypond.org/~janneke/software/cyg-apt

Revision 3
* Changed tabs to spaces: tabs were confusing Python and causing spurious indentation complains.

* Import pdb for debugging
* Change the hardcoded mirror and cache locations
official_mirror = 'http://gnu.kookel.org/ftp/cygwin'
cache = ROOT + '/var/cache/setup' 
becomes
official_mirror = 'http://mirror.internode.on.net/pub/cygwin/'
cache = ROOT + '/e/home/application_data/cygwin' 

* Fix indentation of a line in options parsing in the script lines outside any function at the top.
        cache = a

* in get_requires(): only look for dependencies in [curr], not in distname which is the selected version of the selected package. My thinking is that those wanting the previous or testing versions of a package probably don't want previous or testing versions of the projects it depends on: there's no gurantee that there is any synchronisation of current-previous-test between packages, or that a previous version or a testing version of dependency exists.

* in get_filelist (): split the decompression of the filelist file into two lines for easier debugging.

* in find () : removed prepending ROOT to the file to search for. ROOT doesn't seem to be a general cygwin concept and I would like to remove it. 

* Changed find () to silently ignore /setup/foo.lst files (containsing installed files for package 'foo') that we would expect to exist from installled.db but aren't actually there. At least with my install some packages were not correctly installed and this file doesn't exist. We should probably warn about these files rather than silently ignore.

Revision 4
----------

Hack in hardcoded Cygwin 1.7 compatibility to cyg-apt. Add temporary fix to package searches: crudely disable regex searches to avoid failing on
 packgenames containing control characters.

Added uninstall tests to test-cyg-apt.py and aimed both install and uninstall tests at the product of the newly added mini_mirror : the testpkg packge. Also added tests for postinstall, preremove and postremove scripts.

Added mini_mirror:
Mini mirror builds a Cywin package from scratch and installs it to a remote server. See mini_mirror/README

Revision 10
-----------

cyg-apt: Fixed bogus warnings about missing postinstall and pre
remove scripts during do_install.

Fixed mini_mirror using .bz extension not .bz2, added exclusion of .svn directories when taring up the mini_mirror package build, fix test-cyg-apt.py to match correct built package.

Revision 14
-----------
Move test-cyg-apt.py and mini_mirror to use utilpack for path handling, and added /setup/utilpack: the installer for said utilpack.

mini_mirror now ignores any file with substring "svn" in the path/name when "building" the build clean target.

Added "purge" command as per apt-get to cyg-apt.
Added test for purge and download commands to test-cyg-apt.


Revision 31
-----------

Added testpkg-lib to mini-mirror: an empty package. Set testpkg to be dependant on it, and add tests for commands requires and missing: testpkg-lib must turn up as one of testpkg's requires and cyg-apt must be able to detect if testpkg-lib has been removed.

To better handle multiple packags in mini_mirror setup-2.ini moved to mini_mirror root: all package build reference it. Similarly the build tools were moved off testpkg's src directory to a common directory at the cyg-apt project root: /tools.

cyg-apt:
Added a better error message for md5 command when target package is missing.

test-cyg-apt:
Add tests for md5, requires and missing commands.

Revision 38
------------

Added a new tool setup_ini_diff_make.py to patch setup.ini. Doubt this will be
the final version: keep generalising the tool. Change mini_mirror to use the
new tool. Also use the new patch tool in test-cyg-apt to test
the "cyg-apt new" command: temporarily patch .ini to report availability of
a new (spurious) version of testpkg: 0.0.2-0. Check cyg-apt new reports the
new version and revert the .ini

Change the standard .cyg-apt to point to a local setup-2.ini

Revsion 39
----------

Removed build command: new cyg-apt regards building as out of scope.
Slightly simplified cyg-apt source command: downloads and unpacks a source tarball into the current working directory. Unlike apt-get we don't automatically apply the cygwin patches: the whole business of building cygwin source packages is non-trivial and cyg-apt is making no attempt to deal with them at this point. Potentially the standard application of cygwin-specific diffs could be included.

This pretty much what it did before, but the build step was removed becasue it looked lillypond specific. Also effectively ignore "SRC" variable for the same reason. We might want to put this back in a more generalised form to support downloading source tarballs to directories other than the current one, but his could be overkill.

Added test for the modified cyg-apt source command. The test is very simple and a little hacky: it executes the command, checks the testpkg-0.0.1-0 directory is present and that a marker file is also present: the mini_mirror source package build tree is also checked for the file as a sanity check in case the mini_mirror changes. It's becoming a problem that the "source" package from mini_mirror is just a duplicate of the binary: sufficent for testing but confusing to newcomers!

Also cleaned up other lilly-pond specific comments variables and script lines in cyg-apt, mostly at the top level of the script: EXTRA, MKNETREL, PATCH and some lines from setup() which appeared to be both lillypond and mingw specific. I'm (chrisc) thinking that cyg-apt should focus on complete tested functionality on Cygwin and not worry about MinGW for now, if ever.

Commented out the hardcoded initial values for offical_mirror, mirror, cache and downloads: until this is sorted out I'd prefer cyg-apt breaks if not given a .cyg-apt or command line arguments for mirror and cache.

Revision 41
-----------

Fixed comment on cyg-apt uninstall_want_file_removed(): as it stands any function __doc__ string is reported in the --help as if the function is a command and uninstall_want_file_removed() is not a command.

Fixed cyg-apt url command: wasn't prefixing with mirror url.

Added a test for fixed cyg-apt url command.

Revision 42
-----------
*Added a very basic test for buildrequires:

The same tests as normal requires since there's very little difference in the Cygwin packaging system. I don't think the existing buildrequires code in cyg-apt is quite right: it looks for
external-source in .ini package properties but it doesn't appear there, it appears in setup.hint: needs a fix and a better test. In practice external-source is rarely used.

*Added mini_mirror support for the cyg-apt upgrade test: 

mini_mirror now creates a 0.0.2-0 version of testpkg which contains a single additional file as a test marker: /etc/ver2_marker.

* Added a test for upgrade:

installs 0.0.1-0, patches the installed setup-2.ini to indicate 0.0.2-0 as the current version then attempts an upgrade: proper behaviour is the automatic uninstallation of 0.0.1-0 followed by installation of 0.0.2-0. Currently we only check for ver2_marker: a better test would also check for the non-existance of a 0.0.1-0 only file.

* Fiddled with requires inplementation

Use a less confusing list comprehension. I notice the implemenation isn't as efficent as it could be: packages have their requirements merged in to the dictionary multiple times.

* Moved the setup-2.ini used in testing back to /etc/setup-2.ini until I get it sorted out.

* Last commit before culling the top-level script.

Revision 44
-----------

Added a test for cyg-apt update.

Big architectural change to cyg-apt: gathered the top-level script into a "main" function which has the same role with the advantage of being all in the one place: the top level script was scattered through the file, which makes it very hard to track what happens before the execution of the command entry point. This proved harder than expected due to the large number of existing globals and the way that .cyg-apt is read into the top level's __dict__ necessitating more globals to keep it working.

Passes all the tests in the testsuite but this was such a disruptive change I expect more bugs in the future.

Revision 45
-----------

Change "basename" to "scriptname" when referring to sys.argv[0] to avoid confusion with other uses of basename, and stop passing it around as global.

Added "get_rc()" in line with get_installed() and get_setup(): localise configuration of cyg-apt from .cyg-apt into one function. This includes both reading values and (currently) expanding values by (for example) adding known path chunks.

Rearrange Main: group the four main things it does:
setting up constants
parsing the rc
command line overrides
read in the cygwin package database

Also: don't special case the launching of the update and setup commands: a simple if statement avoids reading in the package database in these cases. (Don't read packge db in: these commands don't count on it existing: setup (potentially creates a fresh empty db) while update overwrites setup.in.

Revision 47
-----------

Moved determing if .cyg-apt exists and if so which one to use back to main. get_rc() and setup() both use this info: get_rc to read in .cyg-apt and setup as an indicator of whether it should create .cyg-apt or not.

Add ability to create .cyg-apt from hardcoded constants to setup() and warnings if setup() is invoked with an existing .cyg-apt: refuses to overwrite.


Revision 49
-----------

Added get_setup_rc(location): reads the Cygwin package database .rc located at /etc/setup/setup.rc and takes last-cache and last-mirror as (sensible) defaults for a new .cyg-apt. Big advtange of this is that new users can now run cyg-apt setup and expect the next command to work (using the last mirror / package cache they accessed using setup.exe.

Added warnings to setup() if /etc/seutp.rc is not found and empty-string default values for mirror and package cache for this case. I expect this case to be rare in practice.

Added verison detection: 1.7 currently uses setup-2.ini not setup.ini: good to pick this up as a default for a fresh .cyg-apt. Will need to remove this once 1.7 moves back to setup.ini

Added sanity check get_rc: if cache or mirror is not defined print an informative error message and exit.

Note -- this new model is quite different from the old one: now a complete .cyg-apt is always required: command line arguments are *strictly overrides* to this initial requirement. It also means you have to create .cyg-apt before running .cyg-apt or (much more common) let cyg-apt setup create one for you.

Revision 50
-----------

Fix the ROOT problem: previously the global ROOT was being applied both as an absolute directory e.g. "tar -C ROOT" and as a path prefix ie:
ROOT + /etc/setup/setup.ini
One constant can't fufill both roles well: to have "/" as root (ie the usual case) you have to use "/." to avoid ROOT + /etc/setup/setup.ini becoming "//etc/setup/setup.ini". Using paths like "etc/setup/setup.ini" are a trap for new developers.

The solution is to have two forms of ROOT: PREFIX_ROOT "" and ABSOLUTE_ROOT "/" which expands well to "/e/home/some/dir/" and "/e/home/some/dir" for a non-null root, not that we expect to be using this since running cyg-apt outside Cygwin is not a (tested) release target at this stage.

Change .cyg-apt to take advantage of the more sensible "/" root.

No test for setup yet.

Revision 51
-----------

Added a test for cyg-apt setup: removes .cyg-apt in cwd and HOME, calls cyg-apt setup and checks the mirror and cache match Cygwin's setup.rc. Then restores .cyg-apt as required.

Fixed TestCygApt.testlist: broke up the horrible regex into three bite-sized regexes, adding a regex to match on the new version available field when it is present.

Revision 52
-----------

Now run the testsetup cleanup code always, even if an exception is thrown (important given we're moving the developer's cyg-apt files around during testing.

Changed testinstall_remove to call core do_testinstalll_remove for the actual tests: this allows this testing code to be shared between testinstall_remove and testcommandline.

Added testcommandline: it has a fairly heavyweight test for --cache= option: it actually copies the whole (testing) package cache to a new directory and confirms we can remove/install the testpkg. Has always-cleanup behaviour as per testsetup (see above)

Revision 53
-----------













